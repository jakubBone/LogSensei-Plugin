# Workflow for publishing plugin to JetBrains Marketplace
name: Release

# Trigger on version tags only
on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run tests
        run: ./gradlew test

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Publish to Marketplace
        env:
          PUBLISH_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}
        run: ./gradlew publishPlugin

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/distributions/*.zip
          body: |
            ## What's New in 0.5.0
            
            ### Added
            - **CI/CD pipeline**
              - GitHub Actions workflow for build and test
              - Release workflow for automatic Marketplace publishing
              - Branch protection rules (master)
            - **Integration tests**
              - `CatchBlockInspectionTest`
              - `EarlyReturnInspectionTest`
              - `LoopInspectionTest`
              - `ServiceMethodInspectionTest`
            - **QuickFix tests**
              - `CatchBlockQuickFixTest`
              - `EarlyReturnQuickFixTest`
              - `LoopQuickFixTest`
              - `ServiceMethodQuickFixTest`
            - **Marketplace publishing**
              - Automatic publishing on version tags (v*)
              - Updated `plugin.xml` with full description
            
            ### Changed
            - Reorganized test structure: `unit/` and `integration/` packages
            - Updated `build.gradle` with publishing configuration
            
            ---
            
            ### Installation
            **From Marketplace:** Settings → Plugins → Marketplace → search "LogSensei"
            
            **Manual:** Download ZIP below → Settings → Plugins → ⚙️ → Install from Disk